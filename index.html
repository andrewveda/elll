<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Voice & Text Submission</title>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f9f9f9; }
h1 { text-align: center; }
.question { background: #fff; padding: 15px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
textarea { width: 100%; height: 80px; margin-top: 8px; padding: 8px; font-size: 16px; }
button { padding: 10px 20px; margin-top: 10px; cursor: pointer; }
.score { font-weight: bold; margin-top: 5px; }
</style>
</head>
<body>

<h1>Student Text & Voice Submission</h1>
<label>Student Name: <input type="text" id="studentName" placeholder="Enter your name"></label>

<div class="question" data-qid="1">
  <p><b>Question 1:</b> Describe your favourite book.</p>
  <textarea placeholder="Type your answer here"></textarea><br>
  <button onclick="startRecording(this)">Start Recording</button>
  <button onclick="stopRecording(this)">Stop & Score</button>
  <div class="score"></div>
</div>

<div class="question" data-qid="2">
  <p><b>Question 2:</b> Describe your favourite hobby.</p>
  <textarea placeholder="Type your answer here"></textarea><br>
  <button onclick="startRecording(this)">Start Recording</button>
  <button onclick="stopRecording(this)">Stop & Score</button>
  <div class="score"></div>
</div>

<button onclick="submitAll()">Submit All Answers</button>

<script>
let mediaRecorder;
let audioChunks = [];
let currentQuestion;

async function startRecording(btn) {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  currentQuestion = btn.closest('.question');
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();
  alert('Recording started. Speak clearly!');
}

async function stopRecording(btn) {
  if (!mediaRecorder) return;
  mediaRecorder.stop();
  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const typedText = currentQuestion.querySelector('textarea').value;
    const voiceScore = await scoreVoice(typedText, audioBlob);
    currentQuestion.querySelector('.score').innerText = `Voice Score: ${voiceScore}%`;
    currentQuestion.dataset.voiceScore = voiceScore;
    currentQuestion.dataset.audioBlob = audioBlob; // optional save
  };
}

async function scoreVoice(typedText, audioBlob) {
  // Convert audio to base64
  const arrayBuffer = await audioBlob.arrayBuffer();
  const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));

  // Send to your Google Cloud Speech-to-Text API
  // For demo, we use random score (replace this with API call)
  const score = Math.floor(Math.random() * 41) + 60; // 60-100%
  return score;
}

async function submitAll() {
  const studentName = document.getElementById('studentName').value;
  if (!studentName) { alert('Enter your name!'); return; }

  const questions = Array.from(document.querySelectorAll('.question')).map(q => ({
    typedText: q.querySelector('textarea').value,
    voiceScore: q.dataset.voiceScore || 0
  }));

  const res = await fetch('<https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec>', {
    method: 'POST',
    body: JSON.stringify({ studentName, questions }),
    headers: { 'Content-Type': 'application/json' }
  });

  const result = await res.json();
  if (result.status === 'success') alert('Submission successful!');
}
</script>

</body>
</html>
