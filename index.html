<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Voice Quest 🌌</title>
<style>
body { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: radial-gradient(circle at top left,#0f0c29,#302b63,#24243e); color:#e0e0e0; text-align:center; }
.container { max-width:800px; margin:2rem auto; background: rgba(30,30,50,0.8); padding:2rem; border-radius:15px; box-shadow:0 0 40px rgba(72,61,139,0.5);}
button { padding:1rem; border:none; border-radius:10px; font-size:1rem; cursor:pointer; background-color:#4a3f9f; color:#fff; transition: background-color 0.3s ease, box-shadow 0.3s ease;}
button:hover { background-color:#6c5fc7; box-shadow:0 0 15px rgba(108,95,199,0.6);}
.correct { background-color: #00ff9f !important; color:#000; }
.wrong { background-color: #ff4f6e !important; color:#fff; }
#sentenceBox { margin-top:1rem; font-weight:bold; }
.feedback { margin-top:0.5rem; font-size:1rem; }
audio { margin-top:0.5rem; }
</style>
</head>
<body>

<div class="container" id="setupContainer">
  <h2>Voice Quest</h2>
  <label>Name:</label>
  <input type="text" id="nameInput" placeholder="Enter your name"/><br>

  <label>Department:</label>
  <select id="departmentSelect">
    <option value="">-- Select Department --</option>
    <option value="Cyber Security">Cyber Security</option>
    <option value="Mechanical">Mechanical</option>
  </select><br>

  <label>Register Number:</label>
  <select id="regNoSelect">
    <option value="">-- Select Register Number --</option>
  </select><br>

  <button onclick="beginQuest()">Start Quest</button>
</div>

<div class="container" id="questContainer" style="display:none;">
  <h2>Read the Sentence Aloud</h2>
  <div id="sentenceBox"></div>
  <button id="startRec">🎤 Start Speaking</button>
  <button id="stopRec" disabled>⏹ Stop</button>
  <div class="feedback" id="feedback"></div>
  <div id="audioControls"></div>
</div>

<div class="container" id="scoreContainer" style="display:none;">
  <h2>🎉 Quest Completed!</h2>
  <div id="scoreCard"></div>
  <button id="restartBtn">🔄 Restart</button>
</div>

<script>
// HARD-CODED DATA
const data = [
  {department:"Cyber Security", regNo:"CS101", sentence:"Grit gathers glory, grows greatness and makes grand the game of life"},
  {department:"Cyber Security", regNo:"CS102", sentence:"Be yourself everyone else is already taken"},
  {department:"Mechanical", regNo:"ME101", sentence:"Engineering minds build bridges and shape the world"},
  {department:"Mechanical", regNo:"ME102", sentence:"Innovation comes from persistence and curiosity"}
];

const departmentSelect = document.getElementById("departmentSelect");
const regNoSelect = document.getElementById("regNoSelect");
const sentenceBox = document.getElementById("sentenceBox");
const feedback = document.getElementById("feedback");
const audioControls = document.getElementById("audioControls");

let playerName="", playerDepartment="", playerRegNo="", currentSentence="";
let similarityScore=0;
let mediaRecorder;
let audioChunks = [];

// Populate register numbers based on department
departmentSelect.addEventListener('change', ()=>{
  const dept = departmentSelect.value;
  regNoSelect.innerHTML = '<option value="">-- Select Register Number --</option>';
  data.filter(d=>d.department===dept).forEach(d=>{
    const option = document.createElement('option');
    option.value = d.regNo;
    option.textContent = d.regNo;
    regNoSelect.appendChild(option);
  });
});

function beginQuest(){
  playerName = document.getElementById("nameInput").value.trim();
  playerDepartment = departmentSelect.value;
  playerRegNo = regNoSelect.value;
  if(!playerName || !playerDepartment || !playerRegNo){
    alert("Please fill all fields!");
    return;
  }
  const entry = data.find(d=>d.department===playerDepartment && d.regNo===playerRegNo);
  currentSentence = entry.sentence;
  sentenceBox.textContent = currentSentence;
  
  document.getElementById("setupContainer").style.display = "none";
  document.getElementById("questContainer").style.display = "block";
}

// SPEECH RECOGNITION + MEDIA RECORDER
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang="en-GB";
recognition.interimResults=false;

document.getElementById("startRec").addEventListener("click", async ()=>{
  // reset
  audioChunks = [];
  audioControls.innerHTML="";
  feedback.textContent="🎙️ Listening...";
  
  // Start recording
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.start();
  
  mediaRecorder.ondataavailable = e => { audioChunks.push(e.data); };
  mediaRecorder.onstop = ()=>{ createPlaybackAndDownload(); };
  
  // Start speech recognition
  recognition.start();
  document.getElementById("startRec").disabled = true;
  document.getElementById("stopRec").disabled = false;
});

document.getElementById("stopRec").addEventListener("click", ()=>{
  recognition.stop();
  mediaRecorder.stop();
  document.getElementById("startRec").disabled = false;
  document.getElementById("stopRec").disabled = true;
});

recognition.onresult = (event)=>{
  const spoken = event.results[0][0].transcript.trim().toLowerCase();
  similarityScore = compareText(spoken,currentSentence.toLowerCase());
  if(similarityScore>=0.7){
    feedback.textContent = `✅ Correct! (${Math.round(similarityScore*100)}%)`;
    feedback.className="correct";
  } else {
    feedback.textContent = `❌ Incorrect (${Math.round(similarityScore*100)}%)`;
    feedback.className="wrong";
  }
  
  // Show score container
  document.getElementById("questContainer").style.display="none";
  document.getElementById("scoreContainer").style.display="block";
  document.getElementById("scoreCard").innerHTML=`
    <p>👤 Player: ${playerName}</p>
    <p>📊 Accuracy: ${Math.round(similarityScore*100)}%</p>
    <p>🏷 Department: ${playerDepartment}</p>
    <p>🔢 Register No: ${playerRegNo}</p>
  `;
};

recognition.onerror = (event)=>{
  feedback.textContent = `⚠️ Error: ${event.error}`;
};

// CREATE PLAYBACK AND DOWNLOAD BUTTON
function createPlaybackAndDownload(){
  const blob = new Blob(audioChunks, {type:'audio/webm'});
  const url = URL.createObjectURL(blob);
  
  const audioEl = document.createElement('audio');
  audioEl.controls = true;
  audioEl.src = url;
  
  const downloadBtn = document.createElement('a');
  downloadBtn.href = url;
  downloadBtn.download = `${playerName}_${playerRegNo}.webm`;
  downloadBtn.textContent = "⬇️ Download Recording";
  downloadBtn.style.display="block";
  downloadBtn.style.marginTop="0.5rem";
  downloadBtn.style.color="#00ffff";
  
  audioControls.innerHTML="";
  audioControls.appendChild(audioEl);
  audioControls.appendChild(downloadBtn);
}

// SAME SCORING MECHANISM
function compareText(a,b){ 
  const longer=a.length>b.length?a:b; 
  const shorter=a.length>b.length?b:a; 
  if(longer.length===0)return 1.0; 
  return (longer.length-editDistance(longer,shorter))/longer.length;
}
function editDistance(s1,s2){ 
  s1=s1.toLowerCase(); s2=s2.toLowerCase(); 
  const costs=[]; 
  for(let i=0;i<=s1.length;i++){ 
    let lastValue=i; 
    for(let j=0;j<=s2.length;j++){ 
      if(i===0) costs[j]=j; 
      else{ 
        if(j>0){ 
          let newValue=costs[j-1]; 
          if(s1.charAt(i-1)!==s2.charAt(j-1)) 
            newValue=Math.min(Math.min(newValue,lastValue),costs[j])+1; 
          costs[j-1]=lastValue; 
          lastValue=newValue; 
        } 
      } 
    } 
    if(i>0) costs[s2.length]=lastValue; 
  } 
  return costs[s2.length]; 
}

// RESTART
document.getElementById("restartBtn").addEventListener("click", ()=>{
  document.getElementById("scoreContainer").style.display="none";
  document.getElementById("setupContainer").style.display="block";
  document.getElementById("nameInput").value="";
  departmentSelect.value="";
  regNoSelect.innerHTML = '<option value="">-- Select Register Number --</option>';
  feedback.textContent="";
  audioControls.innerHTML="";
});
</script>

</body>
</html>
